<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="//cdn.jsdelivr.net/npm/d3@5.7.0/dist/d3.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/d3-geo@1.11.3/dist/d3-geo.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/d3-scale@2.1.2/dist/d3-scale.min.js"></script>

    <style></style>
    <script type="text/javascript">
      function draw(geo_data, wages, jsWages) {
        "use strict";
        var margin = 75,
          width = 1400 - margin,
          height = 600 - margin;

        var svg = d3
          .select("body")
          .append("svg")
          .attr("width", width + margin)
          .attr("height", height + margin)
          .append("g")
          .attr("class", "map");

        var projection = d3
          .geoMercator()
          .scale(140)
          .translate([width / 2, height / 1.2]);

        var path = d3.geoPath().projection(projection);

        var map = svg
          .selectAll("path")
          .data(geo_data.features, d => {
            return d.id;
          })
          .enter()
          .append("path")
          .attr("d", path)
          .attr("class", d => d.id)
          .style("fill", "lightBlue")
          .style("stroke", "black")
          .style("stroke-width", 0.5);

        let difference = [];

        Object.keys(wages).forEach(function(country) {
          difference.push({
            country,
            averageTimes: jsWages[country] / wages[country].wage,
            jsWages: jsWages[country],
            wage: wages[country].wage
          });
        });

        const filtered = difference.filter(d => d.averageTimes),
          min = d3.min(filtered, d => d.averageTimes),
          max = d3.max(filtered, d => d.averageTimes);

        var colorScale = d3
          .scaleLinear()
          .domain([min, 1, max])
          .range(["red", "white", "green"]);

        svg
          .selectAll("path")
          .data(filtered, d => {
            return d.country;
          })
          .enter()
          .each(d => {
            d3.select(`path.${d.country}`).style(
              "fill",
              colorScale(d.averageTimes)
            );
          });
      }
    </script>
  </head>
  <body>
    <script type="text/javascript">
      Promise.all([
        d3.json("world_countries.json"),
        d3.json("country-wage.json"),
        d3.json("js-country-wage.json")
      ]).then(responses => draw(responses[0], responses[1], responses[2]));
    </script>
  </body>
</html>
