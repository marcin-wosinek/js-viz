<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="//cdn.jsdelivr.net/npm/d3@5.7.0/dist/d3.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/d3-geo@1.11.3/dist/d3-geo.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/d3-scale@2.1.2/dist/d3-scale.min.js"></script>

    <style></style>
    <script type="text/javascript">
      function draw(geo_data, wages, jsWages, jsBinned) {
        "use strict";

        var margin = 75,
          width = 1140 - margin,
          height = 600 - margin;

        // TODO combine data to avoid going in circles

        var mapSvg = d3
          .select(".map svg")
          .attr("width", width + margin)
          .attr("height", height + margin)
          .append("g")
          .attr("class", "map");

        var projection = d3
          .geoMercator()
          .scale(140)
          .translate([width / 2, height / 1.2]);

        var path = d3.geoPath().projection(projection);

        var map = mapSvg
          .selectAll("path")
          .data(geo_data.features, d => {
            return d.id;
          })
          .enter()
          .append("path")
          .attr("d", path)
          .attr("class", d => d.id)
          .style("fill", "lightBlue")
          .style("stroke", "black")
          .style("stroke-width", 0.5);

        let difference = [];

        Object.keys(wages).forEach(function(country) {
          difference.push({
            country,
            averageTimes: jsWages[country] / wages[country].wage,
            jsWages: jsWages[country],
            wage: wages[country].wage
          });
        });

        const filtered = difference.filter(d => d.averageTimes),
          min = d3.min(filtered, d => d.averageTimes),
          max = d3.max(filtered, d => d.averageTimes);

        var colorScale = d3
          .scaleLinear()
          .domain([min, 1, max])
          .range(["red", "white", "green"]);

        mapSvg
          .selectAll("path")
          .data(filtered, d => {
            return d.country;
          })
          .enter()
          .each(d => {
            d3.select(`path.${d.country}`).style(
              "fill",
              colorScale(d.averageTimes)
            );
          });

        var histogramSvg = d3
          .select(".histogram svg")
          .attr("width", width + margin)
          .attr("height", height + margin)
          .style("fill", "lightBlue")
          .style("stroke", "black")
          .style("stroke-width", 0.5);

        const categories = [
          { key: "I work for free :(" },
          { key: "$0-$10k" },
          { key: "$10k-$30k" },
          { key: "$30k-$50k" },
          { key: "$50k-$100k" },
          { key: "$100k-$200k" },
          { key: "$200k+" }
        ];

        const xScale = d3
          .scaleBand()
          .domain(categories.map(({ key }) => key))
          .range([0, width])
          .paddingInner(0.05);

        var xAxis = d3.axisBottom(xScale);

        histogramSvg
          .append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

        function setHistagram(values) {
          const arrayed = Object.keys(values).map(function(key) {
            return {
              key,
              value: values[key]
            };
          });

          const max = d3.max(arrayed, d => d.value),
            yScale = d3
              .scaleLinear()
              .domain([0, max])
              .range([0, height - 10]);

          histogramSvg
            .selectAll("rect")
            .data(arrayed, d => d.key)
            .attr("x", d => xScale(d.key))
            .attr("y", d => height - yScale(d.value))
            .attr("width", xScale.bandwidth())
            .attr("height", d => yScale(d.value));
        }

        histogramSvg
          .selectAll("rect")
          .data(categories, d => d.key)
          .enter()
          .append("rect");

        setHistagram(jsBinned.global);
      }
    </script>
  </head>
  <body>
    <h1>How much js dev makes compared to average wage</h1>
    <section class="map"><svg></svg></section>

    <section class="histogram">
      <h2>Global</h2>
      <svg id="map"></svg>
    </section>

    <script type="text/javascript">
      Promise.all([
        d3.json("world_countries.json"),
        d3.json("country-wage.json"),
        d3.json("js-country-wage.json"),
        d3.json("js-binned-wages.json")
      ]).then(responses => draw(...responses));
    </script>
  </body>
</html>
